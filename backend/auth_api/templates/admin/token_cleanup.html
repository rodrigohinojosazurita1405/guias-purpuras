{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Gesti√≥n de Tokens JWT{% endblock %}

{% block extrastyle %}
<style>
    .token-cleanup-container {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 20px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 20px;
        margin: 30px 0;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #7C3AED;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .stat-card.warning {
        border-left-color: #F59E0B;
        background: #FFFBEB;
    }

    .stat-card.danger {
        border-left-color: #DC2626;
        background: #FEF2F2;
    }

    .stat-card.success {
        border-left-color: #10B981;
        background: #ECFDF5;
    }

    .stat-label {
        font-size: 14px;
        color: #6B7280;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
    }

    .stat-value {
        font-size: 36px;
        font-weight: 800;
        color: #1F2937;
        margin: 8px 0;
    }

    .stat-description {
        font-size: 13px;
        color: #9CA3AF;
        margin-top: 8px;
    }

    .actions-section {
        background: white;
        border-radius: 12px;
        padding: 32px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin: 30px 0;
    }

    .actions-section h2 {
        font-size: 20px;
        font-weight: 700;
        color: #1F2937;
        margin: 0 0 20px 0;
        padding-bottom: 16px;
        border-bottom: 2px solid #E5E7EB;
    }

    .action-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-top: 24px;
    }

    .action-button {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        padding: 20px;
        border-radius: 10px;
        border: 2px solid #E5E7EB;
        background: white;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .action-button:hover {
        border-color: #7C3AED;
        box-shadow: 0 4px 12px rgba(124, 58, 237, 0.1);
        transform: translateY(-2px);
    }

    .action-button h3 {
        font-size: 16px;
        font-weight: 700;
        color: #1F2937;
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .action-button p {
        font-size: 13px;
        color: #6B7280;
        margin: 0 0 16px 0;
        line-height: 1.6;
    }

    .action-button button {
        width: 100%;
        padding: 12px 20px;
        border: none;
        border-radius: 8px;
        font-weight: 700;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .btn-info {
        background: #DBEAFE;
        color: #1E40AF;
    }

    .btn-info:hover {
        background: #3B82F6;
        color: white;
    }

    .btn-success {
        background: #ECFDF5;
        color: #065F46;
    }

    .btn-success:hover {
        background: #10B981;
        color: white;
    }

    .btn-warning {
        background: #FEF3C7;
        color: #92400E;
    }

    .btn-warning:hover {
        background: #F59E0B;
        color: white;
    }

    .info-box {
        background: #F0F9FF;
        border-left: 4px solid #3B82F6;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .info-box h3 {
        font-size: 16px;
        font-weight: 700;
        color: #1E40AF;
        margin: 0 0 12px 0;
    }

    .info-box p {
        font-size: 14px;
        color: #1E3A8A;
        margin: 8px 0;
        line-height: 1.6;
    }

    .warning-box {
        background: #FFFBEB;
        border-left: 4px solid #F59E0B;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
    }

    .warning-box h3 {
        font-size: 16px;
        font-weight: 700;
        color: #92400E;
        margin: 0 0 12px 0;
    }

    .warning-box p {
        font-size: 14px;
        color: #78350F;
        margin: 8px 0;
        line-height: 1.6;
    }

    .back-link {
        display: inline-block;
        margin: 20px 0;
        padding: 10px 20px;
        background: #7C3AED;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.2s ease;
    }

    .back-link:hover {
        background: #6D28D9;
        transform: translateX(-4px);
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<div class="token-cleanup-container">
    <h1 style="font-size: 28px; font-weight: 800; color: #1F2937; margin: 20px 0;">
        Gesti√≥n de Tokens JWT
    </h1>

    <p style="font-size: 15px; color: #6B7280; margin-bottom: 30px;">
        Administra los tokens de autenticaci√≥n y limpia tokens expirados para mejorar el rendimiento del sistema.
    </p>

    <!-- Estad√≠sticas -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-label">Outstanding Tokens</div>
            <div class="stat-value">{{ stats.total_outstanding }}</div>
            <div class="stat-description">Total de tokens generados</div>
        </div>

        <div class="stat-card {% if stats.expired_outstanding > 50 %}warning{% endif %}">
            <div class="stat-label">Tokens Expirados</div>
            <div class="stat-value">{{ stats.expired_outstanding }}</div>
            <div class="stat-description">Outstanding tokens expirados</div>
        </div>

        <div class="stat-card">
            <div class="stat-label">Blacklisted Tokens</div>
            <div class="stat-value">{{ stats.total_blacklisted }}</div>
            <div class="stat-description">Tokens revocados totales</div>
        </div>

        <div class="stat-card {% if stats.expired_blacklisted > 100 %}danger{% elif stats.expired_blacklisted > 50 %}warning{% else %}success{% endif %}">
            <div class="stat-label">Blacklist Expirados</div>
            <div class="stat-value">{{ stats.expired_blacklisted }}</div>
            <div class="stat-description">Tokens a limpiar</div>
        </div>

        <div class="stat-card success">
            <div class="stat-label">Blacklist Activos</div>
            <div class="stat-value">{{ stats.active_blacklisted }}</div>
            <div class="stat-description">Tokens revocados a√∫n v√°lidos</div>
        </div>
    </div>

    <!-- Alertas -->
    {% if stats.expired_blacklisted > 100 %}
    <div class="warning-box">
        <h3>‚ö†Ô∏è Limpieza Recomendada</h3>
        <p>
            Hay <strong>{{ stats.expired_blacklisted }} tokens expirados</strong> en la blacklist.
            Se recomienda ejecutar la limpieza para mejorar el rendimiento del sistema.
        </p>
        <p>
            <strong>Impacto:</strong> Cada request autenticado consulta la blacklist completa,
            lo que puede ralentizar la aplicaci√≥n.
        </p>
    </div>
    {% endif %}

    <!-- Informaci√≥n -->
    <div class="info-box">
        <h3>‚ÑπÔ∏è ¬øQu√© hace la limpieza de tokens?</h3>
        <p>
            <strong>‚Ä¢ Elimina tokens expirados:</strong> Los tokens JWT que ya expiraron no pueden ser usados
            para autenticaci√≥n, pero siguen ocupando espacio en la base de datos.
        </p>
        <p>
            <strong>‚Ä¢ Mejora el rendimiento:</strong> Reduce el n√∫mero de registros que el sistema debe consultar
            en cada request autenticado, acelerando las validaciones.
        </p>
        <p>
            <strong>‚Ä¢ Seguro:</strong> Solo elimina tokens que ya expiraron. Los tokens activos (no expirados)
            se mantienen intactos.
        </p>
    </div>

    <!-- Acciones -->
    <div class="actions-section">
        <h2>Acciones de Limpieza</h2>

        <div class="action-buttons">
            <!-- Simulaci√≥n -->
            <div class="action-button">
                <h3>üîç Ver Simulaci√≥n</h3>
                <p>
                    Muestra cu√°ntos tokens se eliminar√≠an <strong>sin borrar nada</strong>.
                    √ötil para verificar antes de ejecutar la limpieza real.
                </p>
                <form method="post" style="width: 100%;">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="dry_run">
                    <button type="submit" class="btn-info">Simular Limpieza</button>
                </form>
            </div>

            <!-- Limpieza Normal -->
            <div class="action-button">
                <h3>‚úì Ejecutar Limpieza</h3>
                <p>
                    Elimina todos los tokens expirados de forma segura.
                    Esta es la acci√≥n recomendada para ejecutar peri√≥dicamente.
                </p>
                <form method="post" style="width: 100%;" onsubmit="return confirm('¬øEst√°s seguro de ejecutar la limpieza? Esta acci√≥n NO se puede deshacer.');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="clean">
                    <button type="submit" class="btn-success">Limpiar Ahora</button>
                </form>
            </div>

            <!-- Limpieza Detallada -->
            <div class="action-button">
                <h3>üìä Limpieza Detallada</h3>
                <p>
                    Ejecuta la limpieza mostrando informaci√≥n detallada en la consola del servidor.
                    √ötil para debugging.
                </p>
                <form method="post" style="width: 100%;" onsubmit="return confirm('¬øEjecutar limpieza con detalles verbose? Revisa la consola del servidor.');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="clean_verbose">
                    <button type="submit" class="btn-warning">Limpiar (Verbose)</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Recomendaciones -->
    <div class="info-box" style="margin-top: 30px;">
        <h3>üí° Recomendaciones</h3>
        <p>
            <strong>‚Ä¢ Frecuencia:</strong> Se recomienda ejecutar la limpieza diariamente o semanalmente,
            dependiendo del tr√°fico de tu aplicaci√≥n.
        </p>
        <p>
            <strong>‚Ä¢ Automatizaci√≥n:</strong> Para ejecutar autom√°ticamente, consulta la documentaci√≥n
            en <code>backend/LIMPIEZA_TOKENS_BLACKLIST.md</code> sobre c√≥mo configurar cron o Celery.
        </p>
        <p>
            <strong>‚Ä¢ Monitoreo:</strong> Revisa peri√≥dicamente esta p√°gina para verificar que los tokens
            expirados no se acumulen demasiado (> 1000).
        </p>
    </div>

    <a href="{% url 'admin:token_blacklist_blacklistedtoken_changelist' %}" class="back-link">
        ‚Üê Volver a Blacklisted Tokens
    </a>
</div>
{% endblock %}
